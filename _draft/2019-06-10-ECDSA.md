---
title: "ECDSA"
categories:
  -  math
tags:
  - math
  - cryptography
  - ECC
  - ECDSA
comments: true
---

# 1. ECDSA란?
"Elliptic Curve Digital Signature Algorithm (Elliptic Curve Digital Signature Algorithm) "의 약자로 , 데이터의 디지털 서명 (예 : 파일)을 만들어 보안과 타협하지 않으면서 본인임을 확인할 수 있다.
서명 위조가 불가능하다.

# 2. 필요한 수학 개념
## Modular
한 방향으로는 쉽지만 다른 방향으로는 어려운 일방향 함수를 고안하기 위해 탄생되었다.
시계 연산으로도 알려져있다.

$$x\ mod\ p$$
$$46\ mod\ 12 \equiv 10$$ 

## Modular 합동
정수 $a, b$와 양의 정수 $m$에 대하여 $a-b$가 $m$으로 나누어 떨어진다면, $a$와 $b$ 는 모듈로 $m$ 합동(a is congruent to b modulo m)이다.

$$a\equiv b\ (mod\ m)$$

## Modular 합동의 필요충분조건
$a\equiv b\ (mod\ m)$의 필요충분조건은, $a\ mod\ m = b\ mod\ m$이다.

정수 $a, b$가 모듈로 $m$ 합동이기 위한 필요충분조건은, $a = b+km$을 만족하는 $k$의 존재이다.
($a-b=km$이란 뜻이므로 합동의 정의와 같다)

## Modular 사칙연산 

$$\begin{matrix} 
(a+b)\ mod\ m&=&((a\ mod\ m)+(b\ mod\ m))\ mod\ m\\
(a-b)\ mod\ m&=&((a\ mod\ m)-(b\ mod\ m))\ mod\ m\\
(a\times b)\ mod\ m&=&((a\ mod\ m)\times(b\ mod\ m))\ mod\ m\\
(a\div b)\ mod\ m&=&((a\ mod\ m)\div(b\ mod\ m))\ mod\ m ????
\end{matrix}$$

사칙연산 중 나눗셈에 닫혀있다. 
역원의 곱셈으로 변경하면 성립된다.

$$\begin{matrix} 
(a\div b)\ mod\ m &=& (a\times b^{-1})\ mod\ m\\
&=&((a\ mod\ m)\times(b^{-1}\ mod\ m))\ mod\ m
\end{matrix}$$

## Modular 역원
$b^{-1}$은 모듈러 group 중에서 $b$와 곱하고 모듈러를 취했을 때 $1$이되는 값이다.
$$(b\times b^{-1})\ mod\ m \equiv 1$$

$m$과 서로소인 수($m$과 공통 소인수가 없는 수)만 모듈러 역원($mod\ m$)을 가진다.

모듈러 group에서 곱셈에 대한 역원을 구하는 방법은 여러가지가 있다.
가장 무식하게는 group 내 모든 원소($0$ ~ $m-1$)에 대해서 곱셈을 해본 후 모듈러를 취했을때 1이 나오는 값을 찾으면 된다. 

하지만 수학적으로 더 빠르게 구할 수 있는 방법을 알아보자.

### 페르마의 소정리
정수 $a$를 선택해서 거듭제곱 $a^2, a^3, a^4 ... (mod\ p)$를 계산하면 어떤 규칙성이 있는가?
![](https://mioscode.github.io/assets/images/fermat_little_theorem.png)

패턴을 찾으면, $a\equiv 0$이 아니면 $a^2\equiv 1\ (mod\ 3), a^4\equiv 1\ (mod\ 5), a^6\equiv 1\ (mod\ 7)$
소수 $p$와 서로소인 정수 $a$에 대해 다음과 같은 식이 존재한다.
$$a^{p-1}\equiv 1\quad (mod\ p) $$

식을 전개하면,
$$a^{p-1}=a\times a^{p-2}\equiv 1 \ (mod\ p)$$
$a의$ 역원을 한번에 구할 수 있다.
단, $m$은 소수여야하고 $a$는 $m$과 서로소라는 가정은 충족되어야 한다.

다시 구하려던 식을 정리해보자.
$$\begin{matrix} 
(a\div b)\ mod\ m &=& (a\times b^{-1})\ mod\ m\\
&=&((a\ mod\ m)\times(b^{-1}\ mod\ m))\ mod\ m\\
&=&((a\ mod\ m)\times(b^{m-2}\ mod\ m))\ mod\ m
\end{matrix}$$
#### 소스코드
```C
int fastPow(int base, int exp, int mod) {
    int result = 1;
    for (; exp; exp >>= 1, base = (base * base) % mod) {
        if (exp & 1)
            result = (result * base) % mod;
    }

    return result;
}
```

### 확장 유클리드 알고리즘
페르마의 소정리는 $m$이 소수라는 제약조건이 있다.
확장 유클리드 호제법은 $m$이 소수가 아니어도 $a$와 $m$이 서로소라는 조건만 만족하면 곱셈에 대한 역원을 구할 수 있다.

확장 유클리드 알고리즘(Extended Euclidian Algorithm)은 유클리드 호제법을 확장한 것이다.
$a$와 $b$에 대해서 아래 식을 만족하는 정수 $x, y$짝을 찾아낼 수 있다.
$$ax+by=gcd(a,b)$$

#### 계산방법
**(초기조건)**
$$x_0=1, x_1=0, y_0=1, y_1=1, r_0=a, r_1=b$$
**(진행)**
$$\begin{matrix}
q_i&\gets& |r_{i-1}/r_i|\ (i\ge 1)\\
r_i&\gets& r_{i-2}-r_{i-1}\times q_{i-1}\ (i\ge 2)\\
x_i&\gets& x_{i-2}-x_{i-1}\times q_{i-1}\\
y_i&\gets& y_{i-2}-y_{i-1}\times q_{i-1}
\end{matrix}$$

||$x_i$|$y_i$|$r_i$|$q_i$|
|:-:|:-:|:-:|:-:|:-:|
|$i=0$|$1$|$0$|$a$||
|$i=1$|$0$|$1$|$b$|$\lfloor a/b\rfloor$|
||||$a\ mob\ b$||

**(예제) $15x+6y=3$을 만족시키는 $x,y$ 찾기**
||$x_i$|$y_i$|$r_i$|$q_i$|
|:-:|:-:|:-:|:-:|:-:|
|$i=0$|$1$|$0$|$a=15$||
|$i=1$|$0$|$1$|$b=6$|$\lfloor 15/6\rfloor=2$|
|$i=2$|$1-0\times 2=1$|$0-1\times 2=-2$|$15\ mod\ 6=3$|$\lfloor 6/3\rfloor=2$|
|$i=3$|||$6\ mod\ 3=0$||
$r_i$이 $0$이 되는 순간 나머지가 $0$이 되는, 즉 식이 나누어 떨어지는 $x, y$를 찾았다는 의미이다.
즉, $x_{i-1}$와 $y_{i-1}$이 우리가 구하고자하는 답이다.

검산해보면,
$$15x+6y=15\times 1+6\times (-2)=15-12=3$$
인 것을 확인할 수 있다.

#### 소스코드
```C
// return: <gcd(a, b), n, m>
tuple<int, int, int> xGCD(int a, int b) {
      if (b == 0)
          return make_tuple(a, 1, 0);
      int g, x, y;
      tie(g, x, y) = xGCD(b, a%b);
      return make_tuple(g, y, x-(a/b)*y);
}
```
확장 유클리드 호제법과 모듈러 곱셈에 대한 역원을 연결해보자.

$a$의 곱셈에 대한 역원을 $x$라고 하면 
$$ax\equiv 1\ (mod\ m)$$

모듈로 합동의 필요충분조건에 의해 아래와 같이 전개된다.

$$ax=1+my$$

이 식을 다시쓰면 확장 유클리드 호제법과 같은 식으로 변환할 수 있다.
$$\begin{matrix}
ax&=&1+my\\
ax-my&=&1
\end{matrix}$$ 

그리고 앞에서 전제한 대로 $a$와 $m$이 서로소라면 아래와 같이 변경가능하다.
$$ax-my=gcd(a,m)$$ 

($a$와 $m$의 최대공약수가 1(즉, 서로소)이면 해가 존재하고, 그렇지 않으면 a−1은 존재하지 않는다)

따라서 $a$와 $m$에 대해서 확장 유클리드 호제법을 이용해서 $x$와 $y$를 구하면 $a$의 곱셈에 대한 역원 $x$를 구할 수 있다.

이를 이용해서 처음에 구하려던 식을 정리해보자.

다시 구하려던 식을 정리해보자.
확장 유클리드 호제법을 이용해서 $bx−my=1$ 를 만족하는 $b$의 곱셈에 대한 역원 $x$를 구하면 아래와 같이 바꿀 수 있다.
$$\begin{matrix} 
(a\div b)\ mod\ m &=& (a\times b^{-1})\ mod\ m\\
&=&((a\ mod\ m)\times(b^{-1}\ mod\ m))\ mod\ m\\
&=&((a\ mod\ m)\times(x^{m}\ mod\ m))\ mod\ m
\end{matrix}$$

## 소수의 Modular 연산
소수 $17$ 사용하되, 약수인 $3$ 사용

$$\begin{matrix} 
3^1\, mod\, 17 \equiv 3
\\3^2\, mod\, 17 \equiv 9
\\3^3\, mod\, 17 \equiv 10
\\3^4\, mod\, 17 \equiv 13
\\3^5\, mod\, 17 \equiv 5
\\3^6\, mod\, 17 \equiv 15
\\3^7\, mod\, 17 \equiv 11
\\3^8\, mod\, 17 \equiv 16
\\3^9\, mod\, 17 \equiv 14
\\3^{10}\, mod\, 17 \equiv 8
\\3^{11}\, mod\, 17 \equiv 7
\\3^{12}\, mod\, 17 \equiv 4
\\3^{13}\, mod\, 17 \equiv 12
\\3^{14}\, mod\, 17 \equiv 2
\\3^{15}\, mod\, 17 \equiv 6
\\3^{16}\, mod\, 17 \equiv 1
\end{matrix}$$

연산의 해가 획일적으로 분포
$3$을 generator라고 한다.

만약 $3$에 어떤 지수인 $x$를 올리면 그 해는 똑같은 확률로 $0$에서 $17$사이의 하나의 정수가 된다.

단, 반대의 경우는 어렵다.
$mod$ 연산값으로 $12$이 주어지고 지수인 $13$ 찾기 어렵고, 계속 계산하는 방법 밖에 없다.

이것을 **이산로그 문제**라고 한다.

# 3. ECC
$$y^2 = (x^3 + ax + b)\,\, mod\, p$$

# 4. Private Key 생성
{1, ..., p-1} 범위 중 랜덤 integer $k$를 선택
$$p=kG$$ 

# 5. Public Key

# 6. Sign
파일의 해시(파일 고유 번호)와 함께 개인키를 방정식에 넣으면 서명됨
서명은 R과 S 두부분으로 나뉨

# 7.  검증
서명의 한 부분(S)를 수학 방정식에 넣어 R이 나온다면 그 서명은 유효


$a=bq+r$




# Reference
[https://noasax.github.io/problem%20solving/2017/09/24/Division-in-modular.html](https://noasax.github.io/problem%20solving/2017/09/24/Division-in-modular.html)